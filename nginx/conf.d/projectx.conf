
# Configuration for projectx
# Using variables instead of upstream blocks to avoid startup failures

# Main location block for projectx
location /projectx/ {
    # Dynamic upstream resolution - resolves at request time
    set $upstream_projectx projectx:8083;
    
    # Remove the prefix before proxying
    rewrite ^/projectx(/.*)$ $1 break;
    
    proxy_pass http://$upstream_projectx;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /projectx;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_cache_bypass $http_upgrade;
    
    # Timeout settings
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Handle upstream errors gracefully
    proxy_intercept_errors on;
    error_page 502 503 504 = @projectx_error;
}

# Error handling location for projectx
location @projectx_error {
    return 503 '{
        "error": "Service projectx is temporarily unavailable",
        "service": "projectx",
        "timestamp": "$time_iso8601",
        "message": "The service may be starting up or experiencing issues. Please try again in a few moments."
    }';
    add_header Content-Type application/json;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# Health check endpoint for projectx
location /projectx/health-check {
    set $upstream_projectx projectx:8083;
    proxy_pass http://$upstream_projectx/actuator/health;
    proxy_set_header Host $host;
    proxy_connect_timeout 2s;
    proxy_send_timeout 2s;  
    proxy_read_timeout 2s;
    
    # Return structured response even on failure
    proxy_intercept_errors on;
    error_page 502 503 504 = @projectx_health_error;
}

location @projectx_health_error {
    return 503 '{
        "status": "DOWN",
        "service": "projectx",
        "timestamp": "$time_iso8601"
    }';
    add_header Content-Type application/json;
}