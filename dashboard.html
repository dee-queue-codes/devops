<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Workspace</title>
    <style>
      /* Existing styles */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        background-color: #fafafa;
        font-size: 14px;
        color: #374151;
      }

      .container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 240px;
        background: white;
        border-right: 1px solid #e5e7eb;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        transition: width 0.3s ease, transform 0.3s ease;
      }

      .sidebar.collapsed {
        width: 60px;
      }

      .sidebar.collapsed .workspace-title,
      .sidebar.collapsed .nav-section-title,
      .sidebar.collapsed .nav-item span:not(.nav-icon) {
        display: none;
      }

      .sidebar.collapsed .nav-item {
        justify-content: center;
        padding: 12px 8px;
      }

      .sidebar.collapsed .sidebar-header {
        justify-content: center;
      }

      .sidebar-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 69px;
      }

      .logo {
        width: 20px;
        height: 20px;
        background: #1f2937;
      }

      .workspace-title {
        font-weight: 500;
        color: #1f2937;
      }

      .nav-item {
        padding: 12px 20px;
        cursor: pointer;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 8px;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .nav-icon {
        min-width: 16px;
        flex-shrink: 0;
      }

      .nav-item:hover {
        background: #f9fafb;
      }

      .nav-item.active {
        color: #8b5cf6;
        background: #f3f4f6;
        border-left-color: #8b5cf6;
      }

      .nav-section {
        margin-top: 20px;
      }

      .nav-section-title {
        padding: 12px 20px 8px;
        font-size: 11px;
        font-weight: 600;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Main Content */
      .main {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
      }

      .main.sidebar-collapsed {
        margin-left: 60px;
      }

      .toggle-sidebar {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
      }

      .toggle-sidebar:hover {
        background: #f3f4f6;
      }

      .header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 69px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #1f2937;
      }

      .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .new-btn {
        background: #8b5cf6;
        color: white;
        border: none;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        background: #10b981;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .content {
        padding: 32px;
      }

      /* Projects Grid */
      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
      }

      .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-bottom: 40px;
      }

      .project-card {
        background: white;
        border: 1px solid #e5e7eb;
        padding: 20px;
        cursor: pointer;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .project-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .project-name {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
      }

      .project-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fef2f2;
        color: #dc2626;
        font-size: 13px;
        padding: 4px 8px;
        font-weight: 500;
      }

      .project-status.active {
        background: #f0fdf4;
        color: #166534;
      }

      .status-icon {
        font-size: 12px;
      }

      /* Services Section */
      .services-section {
        margin-top: 40px;
      }

      .services-tabs {
        display: flex;
        margin-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      .tab {
        background: none;
        border: none;
        padding: 12px 16px;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        font-weight: 500;
        font-size: 14px;
      }

      .tab.active {
        color: #8b5cf6;
        border-bottom-color: #8b5cf6;
      }

      .tab-badge {
        background: #8b5cf6;
        color: white;
        padding: 2px 6px;
        font-size: 11px;
        margin-left: 4px;
      }

      .search-box {
        margin-bottom: 16px;
        padding: 16px 20px;
        background: white;
        border: 1px solid #e5e7eb;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        background: white;
        font-size: 14px;
      }

      .search-input::placeholder {
        color: #9ca3af;
      }

      /* Table */
      .table {
        background: white;
        border: 1px solid #e5e7eb;
        overflow: hidden;
      }

      .table-header {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 50px;
        gap: 16px;
        padding: 12px 20px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
      }

      .table-header div {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .table-header div:hover {
        color: #374151;
      }

      .sort-icon {
        width: 12px;
        height: 12px;
        opacity: 0.5;
        transition: opacity 0.2s;
      }

      .sort-icon.active {
        opacity: 1;
        color: #8b5cf6;
      }

      .table-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 50px;
        gap: 16px;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        align-items: center;
        transition: background-color 0.2s;
      }

      .table-row:hover {
        background: #f9fafb;
      }

      .table-row:last-child {
        border-bottom: none;
      }

      .service-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        color: #1f2937;
      }

      .service-icon {
        width: 16px;
        height: 16px;
        color: #6b7280;
      }

      .service-status.suspended {
        color: #dc2626;
        font-weight: 500;
      }

      .service-status.active {
        color: #059669;
        font-weight: 500;
      }

      .menu-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
      }

      .menu-btn:hover {
        background: #f3f4f6;
      }

      /* Project Detail View */
      .project-detail {
        display: none;
      }

      .back-link {
        color: #8b5cf6;
        text-decoration: none;
        margin-bottom: 16px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
      }

      .back-link:hover {
        color: #7c3aed;
      }

      .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .environment-card {
        background: white;
        border: 1px solid #e5e7eb;
        overflow: hidden;
      }

      .environment-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
        color: #1f2937;
      }

      .environment-tabs {
        display: flex;
        padding: 0 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      .environment-search {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 24px;
        color: #1f2937;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #9ca3af;
      }

      .close-btn:hover {
        color: #374151;
      }

      /* Form Styles */
      #create-app-form {
        padding: 20px;
      }

      .form-section {
        margin-bottom: 30px;
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 20px;
      }

      .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .form-section h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #374151;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #374151;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        font-size: 14px;
        color: #374151;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      .form-group small {
        display: block;
        margin-top: 4px;
        color: #6b7280;
        font-size: 12px;
      }

      /* Command and Environment Variable Inputs */
      .command-input,
      .env-var-input {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
      }

      .cmd-part {
        flex: 1;
        min-width: 100px;
      }

      .env-key,
      .env-value {
        flex: 1;
      }

      .command-input button,
      .env-var-input button {
        width: 30px;
        height: 30px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        font-size: 16px;
        color: #374151;
      }

      .command-input button:hover,
      .env-var-input button:hover {
        background: #f9fafb;
      }

      /* Form Actions */
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .form-actions button {
        padding: 10px 20px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        font-size: 14px;
      }

      .form-actions button[type='button'] {
        background: #f3f4f6;
        color: #374151;
      }

      .form-actions button[type='submit'] {
        background: #8b5cf6;
        color: white;
      }

      .form-actions button:hover {
        opacity: 0.9;
      }

      .form-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* App Type Specific Options */
      .app-type-option {
        margin-bottom: 15px;
      }

      .version-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        margin-top: 8px;
      }

      .version-option {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        text-align: center;
        font-size: 14px;
      }

      .version-option.selected {
        background: #8b5cf6;
        color: white;
        border-color: #8b5cf6;
      }

      .version-option:hover {
        border-color: #8b5cf6;
      }

      /* Loading State */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .loading::after {
        content: ' (Loading...)';
        color: #6b7280;
      }

      /* Success Message */
      .success-message {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #166534;
        padding: 12px 16px;
        margin: 16px 0;
        border-radius: 4px;
        display: none;
      }

      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 12px 16px;
        margin: 16px 0;
        border-radius: 4px;
        display: none;
      }

      /* Loading spinner */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Progress Container Styles */
      .progress-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        text-align: center;
        min-width: 300px;
      }

      .progress-bar {
        width: 100%;
        height: 4px;
        background: #f0f0f0;
        border-radius: 2px;
        margin: 10px 0;
        position: relative;
        overflow: hidden;
      }

      .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: #4caf50;
        width: 0;
        animation: progress 3s linear infinite;
      }

      .progress-text {
        font-size: 16px;
        color: #333;
        margin: 10px 0;
      }

      @keyframes progress {
        0% {
          width: 0;
        }
        100% {
          width: 100%;
        }
      }

      .no-projects {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }

      .no-services {
        text-align: center;
        padding: 40px;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="logo"></div>
          <span class="workspace-title">My Workspace</span>
          <button class="toggle-sidebar" onclick="toggleSidebar()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="3" y1="6" x2="21" y2="6" />
              <line x1="3" y1="12" x2="21" y2="12" />
              <line x1="3" y1="18" x2="21" y2="18" />
            </svg>
          </button>
        </div>

        <div class="nav-item active">
          <svg
            class="nav-icon"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
            />
            <polyline points="3.27,6.96 12,12.01 20.73,6.96" />
            <line x1="12" y1="22.08" x2="12" y2="12" />
          </svg>
          <span>Projects</span>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Manage</div>
          <div class="nav-item">
            <svg
              class="nav-icon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              />
              <polyline points="14,2 14,8 20,8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
              <polyline points="10,9 9,9 8,9" />
            </svg>
            <span>Blueprints</span>
          </div>
          <div class="nav-item">
            <svg
              class="nav-icon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="2" y1="12" x2="22" y2="12" />
              <path
                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
              />
            </svg>
            <span>Environment Groups</span>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main">
        <div class="header">
          <div>
            <div class="breadcrumb">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                style="color: #8b5cf6"
              >
                <path
                  d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                />
                <path
                  d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                />
              </svg>
              <span id="page-title">Projects</span>
            </div>
          </div>
          <div class="header-actions">
            <button class="new-btn" id="new-btn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
              <span id="new-btn-text">New</span>
            </button>
            <div class="user-avatar">C</div>
          </div>
        </div>

        <!-- Overview Page -->
        <div class="content" id="overview">
          <h2 class="section-title">Projects</h2>
          <div class="projects-grid" id="projects-grid">
            <div class="loading-spinner"></div>
          </div>

          <div class="services-section">
            <h2 class="section-title">All Services</h2>

            <div class="services-tabs">
              <button class="tab active">
                All <span class="tab-badge" id="total-count">0</span>
              </button>
              <button class="tab">
                Active <span class="tab-badge" id="active-count">0</span>
              </button>
              <button class="tab">
                Suspended <span class="tab-badge" id="suspended-count">0</span>
              </button>
            </div>

            <div class="search-box">
              <input
                type="text"
                class="search-input"
                placeholder="Search services"
              />
            </div>

            <div class="table">
              <div class="table-header">
                <div onclick="sortTable('overview', 'name')">
                  Service Name
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('overview', 'status')">
                  Status
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('overview', 'runtime')">
                  Runtime
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('overview', 'region')">
                  Region
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('overview', 'deployed')">
                  Deployed
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
              </div>

              <div id="services-table-body">
                <div class="loading-spinner" style="margin: 20px auto"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Project Detail Page -->
        <div class="content project-detail" id="project-detail">
          <a href="#" class="back-link" onclick="showOverview()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="19" y1="12" x2="5" y2="12" />
              <polyline points="12,19 5,12 12,5" />
            </svg>
            Dashboard
          </a>

          <div class="project-header">
            <h1 class="page-title" id="project-title">Project</h1>
          </div>

          <div class="environment-card">
            <div class="environment-header">Production</div>

            <div class="environment-tabs">
              <button class="tab active" id="project-all-tab">All (0)</button>
              <button class="tab" id="project-services-tab">
                Services (0)
              </button>
              <button class="tab">Env Groups (0)</button>
            </div>

            <div class="environment-search">
              <input
                type="text"
                class="search-input"
                placeholder="Search resources in Production"
              />
            </div>

            <div class="table">
              <div class="table-header">
                <div onclick="sortTable('project', 'name')">
                  Service Name
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('project', 'status')">
                  Status
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('project', 'region')">
                  Region
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
                <div onclick="sortTable('project', 'deployed')">
                  Deployed
                  <svg
                    class="sort-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M8 9l4-4 4 4" />
                    <path d="M16 15l-4 4-4-4" />
                  </svg>
                </div>
              </div>

              <div id="project-services">
                <div class="loading-spinner" style="margin: 20px auto"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create App Modal -->
    <div id="create-app-modal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create New App</h2>
          <button class="close-btn" onclick="closeCreateAppModal()">
            &times;
          </button>
        </div>

        <div class="success-message" id="success-message"></div>
        <div class="error-message" id="error-message"></div>

        <form id="create-app-form" onsubmit="createNewApp(event)">
          <!-- Basic Info -->
          <div class="form-section">
            <h3>Basic Information</h3>

            <div class="form-group">
              <label for="app-name">App Name*</label>
              <input
                type="text"
                id="app-name"
                placeholder="my-awesome-app"
                required
              />
              <small>Lowercase, no spaces, hyphens allowed</small>
            </div>

            <div class="form-group">
              <label for="github-repo">GitHub Repository*</label>
              <input
                type="url"
                id="github-repo"
                placeholder="https://github.com/username/repo"
                required
              />
            </div>

            <div class="form-group">
              <label for="github-pat">GitHub Personal Access Token*</label>
              <input
                type="password"
                id="github-pat"
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                required
              />
              <small>Needed to clone private repositories</small>
            </div>
          </div>

          <!-- App Configuration -->
          <div class="form-section">
            <h3>App Configuration</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="app-type">App Type*</label>
                <select
                  id="app-type"
                  onchange="updateAppTypeOptions()"
                  required
                >
                  <option value="">Select app type</option>
                  <option value="node">Node.js</option>
                  <option value="java">Java (Spring Boot)</option>
                  <option value="python">Python</option>
                  <option value="go">Go</option>
                  <option value="php">PHP</option>
                  <option value="custom">Custom Dockerfile</option>
                </select>
              </div>

              <div class="form-group">
                <label for="app-port">Internal Port*</label>
                <select id="app-port" required>
                  <option value="">Loading available ports...</option>
                </select>
              </div>
            </div>

            <!-- Dynamic app type specific options -->
            <div id="app-type-options"></div>

            <div class="form-group">
              <label for="start-commands">Start Commands*</label>
              <div id="start-commands-container">
                <div class="command-input">
                  <input type="text" placeholder="npm" class="cmd-part" />
                  <input type="text" placeholder="start" class="cmd-part" />
                  <button type="button" onclick="addCommandPart(this)">
                    +
                  </button>
                  <button type="button" onclick="removeCommandPart(this)">
                    -
                  </button>
                </div>
              </div>
              <small
                >Command to start your application (e.g., npm start, python
                app.py)</small
              >
            </div>

            <div class="form-group">
              <label for="build-command">Build Command (optional)</label>
              <input
                type="text"
                id="build-command"
                placeholder="npm run build"
              />
              <small>Command to build your app before starting</small>
            </div>

            <div class="form-group">
              <label for="health-check">Health Check Command (optional)</label>
              <input
                type="text"
                id="health-check"
                placeholder="curl -f http://localhost:PORT/health"
              />
              <small>Command to check if your app is healthy</small>
            </div>
          </div>

          <!-- Environment Variables -->
          <div class="form-section">
            <h3>Environment Variables</h3>
            <div id="env-vars-container">
              <div class="env-var-input">
                <input
                  type="text"
                  placeholder="VARIABLE_NAME"
                  class="env-key"
                />
                <input type="text" placeholder="value" class="env-value" />
                <button type="button" onclick="addEnvVar()">+</button>
                <button type="button" onclick="removeEnvVar(this)">-</button>
              </div>
            </div>
          </div>

          <!-- Database Configuration -->
          <div class="form-section">
            <h3>Database (Optional)</h3>

            <div class="form-group">
              <label for="db-type">Database Type</label>
              <select id="db-type" onchange="updateDatabaseOptions()">
                <option value="none">No Database</option>
                <option value="postgresql">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="mongodb">MongoDB</option>
                <option value="redis">Redis</option>
              </select>
            </div>

            <div id="database-options" style="display: none">
              <div class="form-row">
                <div class="form-group">
                  <label for="db-name">Database Name</label>
                  <input type="text" id="db-name" placeholder="my_app_db" />
                </div>
                <div class="form-group">
                  <label for="db-username">Username</label>
                  <input type="text" id="db-username" placeholder="app_user" />
                </div>
              </div>
              <div class="form-group">
                <label for="db-password">Password</label>
                <input
                  type="password"
                  id="db-password"
                  placeholder="secure_password_123"
                />
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" onclick="closeCreateAppModal()">
              Cancel
            </button>
            <button type="submit" id="create-app-btn">Create App</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Configuration - Update this to match your server setup
      const SERVER_URL = 'http://localhost:8080' // Change this to your server URL

      let currentProject = ''
      let sidebarCollapsed = false
      let sortState = {
        overview: { column: null, direction: 'asc' },
        project: { column: null, direction: 'asc' }
      }
      let appTemplates = {}
      let availablePorts = []
      let allProjects = []
      let allServices = []

      // Utility functions
      function showMessage(message, isError = false) {
        const successEl = document.getElementById('success-message')
        const errorEl = document.getElementById('error-message')

        if (isError) {
          errorEl.textContent = message
          errorEl.style.display = 'block'
          successEl.style.display = 'none'
        } else {
          successEl.textContent = message
          successEl.style.display = 'block'
          errorEl.style.display = 'none'
        }

        // Hide messages after 5 seconds
        setTimeout(() => {
          successEl.style.display = 'none'
          errorEl.style.display = 'none'
        }, 5000)
      }

      // Dashboard Functions
      function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar')
        const main = document.querySelector('.main')

        sidebarCollapsed = !sidebarCollapsed

        if (sidebarCollapsed) {
          sidebar.classList.add('collapsed')
          main.classList.add('sidebar-collapsed')
        } else {
          sidebar.classList.remove('collapsed')
          main.classList.remove('sidebar-collapsed')
        }
      }

      function sortTable(tableType, column) {
        const state = sortState[tableType]

        // Toggle direction if same column, otherwise start with asc
        if (state.column === column) {
          state.direction = state.direction === 'asc' ? 'desc' : 'asc'
        } else {
          state.column = column
          state.direction = 'asc'
        }

        // Update visual indicators
        updateSortIndicators(tableType, column, state.direction)

        // Get the table rows
        const selector =
          tableType === 'overview'
            ? '#overview .table-row'
            : '#project-detail .table-row'
        const rows = Array.from(document.querySelectorAll(selector))

        // Sort the rows
        rows.sort((a, b) => {
          let valueA, valueB

          switch (column) {
            case 'name':
              valueA = a.querySelector('.service-name').textContent.trim()
              valueB = b.querySelector('.service-name').textContent.trim()
              break
            case 'status':
              valueA = a.querySelector('.service-status').textContent.trim()
              valueB = b.querySelector('.service-status').textContent.trim()
              break
            case 'runtime':
              valueA = a.children[2].textContent.trim()
              valueB = b.children[2].textContent.trim()
              break
            case 'region':
              valueA = a.children[3].textContent.trim()
              valueB = b.children[3].textContent.trim()
              break
            case 'deployed':
              valueA = a.children[4].textContent.trim()
              valueB = b.children[4].textContent.trim()
              break
            default:
              return 0
          }

          // Handle sorting for different data types
          if (column === 'deployed') {
            // Special handling for time values like "2mo", "8mo", etc.
            const timeA = parseTimeValue(valueA)
            const timeB = parseTimeValue(valueB)
            return state.direction === 'asc' ? timeA - timeB : timeB - timeA
          } else {
            // String comparison
            const comparison = valueA.localeCompare(valueB)
            return state.direction === 'asc' ? comparison : -comparison
          }
        })

        // Re-append sorted rows
        const table = document.querySelector(
          tableType === 'overview'
            ? '#overview .table'
            : '#project-detail .table'
        )
        rows.forEach(row => table.appendChild(row))
      }

      function updateSortIndicators(tableType, activeColumn, direction) {
        const selector =
          tableType === 'overview'
            ? '#overview .table-header'
            : '#project-detail .table-header'
        const headers = document.querySelectorAll(`${selector} div`)

        headers.forEach((header, index) => {
          const icon = header.querySelector('.sort-icon')
          if (!icon) return

          const columns = ['name', 'status', 'runtime', 'region', 'deployed']
          const isActive = columns[index] === activeColumn

          if (isActive) {
            icon.classList.add('active')
            // Update icon based on direction
            if (direction === 'asc') {
              icon.innerHTML = '<path d="M8 15l4-4 4 4"/>'
            } else {
              icon.innerHTML = '<path d="M8 9l4 4 4-4"/>'
            }
          } else {
            icon.classList.remove('active')
            icon.innerHTML =
              '<path d="M8 9l4-4 4 4"/><path d="M16 15l-4 4-4-4"/>'
          }
        })
      }

      function parseTimeValue(timeStr) {
        // Convert time strings like "2mo", "8mo", "1mo" to comparable numbers
        const match = timeStr.match(/(\d+)(mo|d|y|h|m)/)
        if (!match) return 0

        const value = parseInt(match[1])
        const unit = match[2]

        // Convert to days for comparison
        switch (unit) {
          case 'y':
            return value * 365
          case 'mo':
            return value * 30
          case 'd':
            return value
          case 'h':
            return value / 24
          case 'm':
            return value / (24 * 60)
          default:
            return value
        }
      }

      function showOverview() {
        document.getElementById('overview').style.display = 'block'
        document.getElementById('project-detail').style.display = 'none'
        document.getElementById('page-title').textContent = 'Projects'
        document.getElementById('new-btn-text').textContent = 'New'
      }

      function showProject(projectName) {
        currentProject = projectName
        document.getElementById('overview').style.display = 'none'
        document.getElementById('project-detail').style.display = 'block'
        document.getElementById('page-title').textContent = projectName
          .toLowerCase()
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ')
        document.getElementById('project-title').textContent = projectName
          .toLowerCase()
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ')
        document.getElementById('new-btn-text').textContent = 'Add environment'

        // Filter services for this project
        const projectServices = allServices.filter(
          service =>
            service.name === projectName || service.name === `${projectName}-db`
        )

        renderProjectServices(projectServices)

        // Update tab counts
        const allCount = projectServices.length
        const servicesCount = projectServices.length
        document.getElementById(
          'project-all-tab'
        ).textContent = `All (${allCount})`
        document.getElementById(
          'project-services-tab'
        ).textContent = `Services (${servicesCount})`

        // Re-setup project tabs after content is loaded
        setTimeout(() => {
          setupProjectTabs()

          // Setup project detail search
          const detailSearch = document.querySelector(
            '#project-detail .search-input'
          )
          if (detailSearch) {
            detailSearch.addEventListener('input', function () {
              const searchTerm = this.value.toLowerCase()
              filterServicesBySearch(searchTerm, '#project-detail')
            })
          }
        }, 100)
      }

      // API Functions
      async function fetchDockerCompose() {
        try {
          const response = await fetch(`${SERVER_URL}/api/apps/compose`)
          if (!response.ok) {
            throw new Error('Failed to fetch docker-compose data')
          }
          return await response.json()
        } catch (error) {
          console.error('Error fetching docker-compose:', error)
          return null
        }
      }

      async function checkHealth(appName) {
        try {
          const response = await fetch(
            `${SERVER_URL}/${appName}/health-check`,
            {
              timeout: 5000
            }
          )

          if (!response.ok) {
            return { status: 'DOWN', details: 'HTTP ' + response.status }
          }

          const healthData = await response.json()
          return healthData
        } catch (error) {
          return { status: 'DOWN', details: error.message }
        }
      }

      function parseServices(composeData) {
        const services = []
        const projects = new Set()

        if (!composeData || !composeData.services) {
          return { services, projects: Array.from(projects) }
        }

        Object.entries(composeData.services).forEach(
          ([serviceName, serviceConfig]) => {
            // Skip app-manager and nginx services
            if (serviceName === 'app-manager' || serviceName === 'nginx') {
              return
            }

            // Determine if this is a database service
            const isDatabase = serviceName.endsWith('-db')
            let projectName, serviceType, runtime

            if (isDatabase) {
              // Extract project name from database service (e.g., "projectx-db" -> "projectx")
              projectName = serviceName.replace('-db', '')
              serviceType = 'database'
              runtime = getImageRuntime(serviceConfig.image)
            } else {
              // This is the main application service
              projectName = serviceName
              serviceType = 'application'
              runtime = 'Unknown' // Will be determined from build context or image

              // Add project to the set
              projects.add(projectName)
            }

            services.push({
              name: serviceName,
              projectName: projectName,
              type: serviceType,
              runtime: runtime,
              port: serviceConfig.expose ? serviceConfig.expose[0] : null,
              image: serviceConfig.image,
              buildContext: serviceConfig.build?.context,
              environment: serviceConfig.environment || {},
              status: 'unknown',
              healthDetails: null
            })
          }
        )

        return { services, projects: Array.from(projects) }
      }

      function getImageRuntime(image) {
        if (!image) return 'Unknown'

        if (image.includes('postgres')) return 'PostgreSQL'
        if (image.includes('mysql')) return 'MySQL'
        if (image.includes('mongo')) return 'MongoDB'
        if (image.includes('redis')) return 'Redis'
        if (image.includes('nginx')) return 'Nginx'
        if (image.includes('node')) return 'Node.js'
        if (image.includes('python')) return 'Python'
        if (
          image.includes('java') ||
          image.includes('openjdk') ||
          image.includes('temurin')
        )
          return 'Java'
        if (image.includes('golang') || image.includes('go:')) return 'Go'
        if (image.includes('php')) return 'PHP'

        return 'Custom'
      }

      function getBuildRuntime(serviceConfig) {
        if (!serviceConfig.build) return null

        const context = serviceConfig.build.context || serviceConfig.build
        if (typeof context === 'string') {
          // Try to infer from build context path
          if (context.includes('node') || context.includes('js'))
            return 'Node.js'
          if (context.includes('java') || context.includes('spring'))
            return 'Java Spring Boot'
          if (
            context.includes('python') ||
            context.includes('django') ||
            context.includes('flask')
          )
            return 'Python'
          if (context.includes('go') || context.includes('golang')) return 'Go'
          if (context.includes('php')) return 'PHP'
        }

        return 'Custom Build'
      }

      async function updateServicesHealth() {
        if (allServices.length === 0) return

        console.log('ðŸ”„ Updating service health status...')
        const updatedServices = []

        for (const service of allServices) {
          if (service.type === 'application') {
            // Check health of main application
            const healthData = await checkHealth(service.projectName)
            service.status = healthData.status
            service.healthDetails = healthData
            service.lastChecked = new Date().toISOString()

            // If application has database component, check DB status from health endpoint
            const dbService = allServices.find(
              s => s.name === `${service.projectName}-db`
            )
            if (
              dbService &&
              healthData.components &&
              healthData.components.db
            ) {
              dbService.status = healthData.components.db.status
              dbService.healthDetails = healthData.components.db
              dbService.lastChecked = service.lastChecked

              // Update database runtime from health details if available
              if (healthData.components.db.details?.database) {
                dbService.runtime = healthData.components.db.details.database
              }
            } else if (dbService) {
              // Database service exists but no health info from app
              dbService.status = service.status === 'UP' ? 'UP' : 'DOWN'
              dbService.lastChecked = service.lastChecked
            }
          }
          updatedServices.push(service)
        }

        allServices = updatedServices
        renderServices()
        renderProjects()
        updateCounts()

        console.log(`âœ… Updated health for ${allServices.length} services`)
      }

      function renderProjects() {
        const projectsGrid = document.getElementById('projects-grid')

        if (allProjects.length === 0) {
          projectsGrid.innerHTML =
            '<div class="no-projects">No projects found. Create your first app using the "New" button above.</div>'
          return
        }

        projectsGrid.innerHTML = ''

        allProjects.forEach(projectName => {
          const projectServices = allServices.filter(
            s => s.projectName === projectName
          )
          const appService = projectServices.find(s => s.type === 'application')
          const dbService = projectServices.find(s => s.type === 'database')

          // Determine overall project status
          let projectStatus = 'Suspended'
          let statusClass = ''
          let statusIcon = 'âœ•'

          if (appService && appService.status === 'UP') {
            if (dbService && dbService.status === 'UP') {
              projectStatus = 'Active (App + DB)'
            } else {
              projectStatus = 'Active (App only)'
            }
            statusClass = 'active'
            statusIcon = 'âœ“'
          } else if (dbService && dbService.status === 'UP') {
            projectStatus = 'DB Active, App Down'
          }

          const projectCard = document.createElement('div')
          projectCard.className = 'project-card'
          projectCard.onclick = () => showProject(projectName)

          projectCard.innerHTML = `
           <div class="project-name">${projectName}</div>
           <div class="project-status ${statusClass}">
             <span class="status-icon">${statusIcon}</span>
             <span>${projectStatus}</span>
           </div>
         `

          projectsGrid.appendChild(projectCard)
        })
      }

      function renderServices() {
        const servicesTableBody = document.getElementById('services-table-body')

        if (allServices.length === 0) {
          servicesTableBody.innerHTML =
            '<div class="no-services">No services found.</div>'
          return
        }

        servicesTableBody.innerHTML = ''

        allServices.forEach(service => {
          const row = document.createElement('div')
          row.className = 'table-row'

          const statusText = service.status === 'UP' ? 'Active' : 'Suspended'
          const statusClass = service.status === 'UP' ? 'active' : 'suspended'

          const icon =
            service.type === 'database'
              ? '<svg class="service-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>'
              : '<svg class="service-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>'

          row.innerHTML = `
           <div class="service-name">
             ${icon}
             ${service.name}
           </div>
           <div class="service-status ${statusClass}">${statusText}</div>
           <div>${service.runtime}</div>
           <div>Local</div>
           <div>-</div>
         `

          servicesTableBody.appendChild(row)
        })
      }

      function renderProjectServices(projectServices) {
        const container = document.getElementById('project-services')

        if (projectServices.length === 0) {
          container.innerHTML =
            '<div class="no-services">No services found for this project.</div>'
          return
        }

        container.innerHTML = ''

        projectServices.forEach(service => {
          const row = document.createElement('div')
          row.className = 'table-row'

          const statusText = service.status === 'UP' ? 'Active' : 'Suspended'
          const statusClass = service.status === 'UP' ? 'active' : 'suspended'

          const icon =
            service.type === 'database'
              ? '<svg class="service-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>'
              : '<svg class="service-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>'

          row.innerHTML = `
           <div class="service-name">
             ${icon}
             ${service.name}
           </div>
           <div class="service-status ${statusClass}">${statusText}</div>
           <div>${service.runtime}</div>
           <div>Local</div>
           <div>-</div>
         `

          container.appendChild(row)
        })
      }

      function updateCounts() {
        const activeCount = allServices.filter(s => s.status === 'UP').length
        const suspendedCount = allServices.filter(s => s.status !== 'UP').length
        const totalCount = allServices.length

        document.getElementById('active-count').textContent = activeCount
        document.getElementById('suspended-count').textContent = suspendedCount
        document.getElementById('total-count').textContent = totalCount
      }

      function setupTabs() {
        // Overview page tabs
        const overviewTabs = document.querySelectorAll(
          '#overview .services-tabs .tab'
        )
        overviewTabs.forEach(tab => {
          tab.addEventListener('click', function () {
            // Remove active class from all overview tabs
            overviewTabs.forEach(t => t.classList.remove('active'))
            // Add active class to clicked tab
            this.classList.add('active')

            const tabText = this.textContent.toLowerCase()
            filterServices(tabText)
          })
        })

        // Project detail tabs - need to setup when project is shown
        setupProjectTabs()
      }

      function setupProjectTabs() {
        const detailTabs = document.querySelectorAll(
          '#project-detail .environment-tabs .tab'
        )
        detailTabs.forEach(tab => {
          tab.addEventListener('click', function () {
            // Remove active class from all detail tabs
            detailTabs.forEach(t => t.classList.remove('active'))
            // Add active class to clicked tab
            this.classList.add('active')

            const tabText = this.textContent.toLowerCase()
            filterProjectResources(tabText)
          })
        })
      }

      function setupSearch() {
        // Overview search
        const overviewSearch = document.querySelector('#overview .search-input')
        if (overviewSearch) {
          overviewSearch.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase()
            filterServicesBySearch(searchTerm, '#overview')
          })
        }
      }

      function filterServices(tabType) {
        const tableRows = document.querySelectorAll('#overview .table-row')

        tableRows.forEach(row => {
          const statusElement = row.querySelector('.service-status')
          const status = statusElement.textContent.toLowerCase()

          if (tabType.includes('active')) {
            // Show only active services
            if (status.includes('active')) {
              row.style.display = ''
            } else {
              row.style.display = 'none'
            }
          } else if (tabType.includes('suspended')) {
            // Show only suspended services
            if (status.includes('suspended')) {
              row.style.display = ''
            } else {
              row.style.display = 'none'
            }
          } else {
            // Show all services
            row.style.display = ''
          }
        })
      }

      function filterProjectResources(tabType) {
        const tableRows = document.querySelectorAll(
          '#project-detail .table-row'
        )

        tableRows.forEach(row => {
          const serviceName = row
            .querySelector('.service-name')
            .textContent.toLowerCase()

          if (tabType.includes('services')) {
            // Show only services (all current items are services)
            row.style.display = ''
          } else if (tabType.includes('env groups')) {
            // Hide all since we have no env groups
            row.style.display = 'none'
          } else {
            // Show all
            row.style.display = ''
          }
        })
      }

      function filterServicesBySearch(searchTerm, containerSelector) {
        const tableRows = document.querySelectorAll(
          `${containerSelector} .table-row`
        )

        tableRows.forEach(row => {
          const serviceName = row
            .querySelector('.service-name')
            .textContent.toLowerCase()
          const runtime = row.children[2]?.textContent.toLowerCase() || ''

          if (
            serviceName.includes(searchTerm) ||
            runtime.includes(searchTerm)
          ) {
            row.style.display = ''
          } else {
            row.style.display = 'none'
          }
        })
      }

      // Modal Functions (keeping existing modal code)
      async function initializeCreateAppModal() {
        try {
          // Load app templates from server
          const templatesResponse = await fetch(
            `${SERVER_URL}/api/apps/templates`
          )
          if (!templatesResponse.ok) {
            throw new Error('Failed to load app templates')
          }
          appTemplates = await templatesResponse.json()

          // Load available ports from server
          await loadAvailablePorts()
        } catch (error) {
          console.error('Error initializing modal:', error)
          showMessage(
            'Failed to load app configuration. Please try again.',
            true
          )
        }
      }

      async function loadAvailablePorts() {
        try {
          const response = await fetch(`${SERVER_URL}/api/ports/available`)
          if (!response.ok) {
            throw new Error('Failed to load available ports')
          }

          const data = await response.json()
          availablePorts = data.availablePorts

          const portSelect = document.getElementById('app-port')
          portSelect.innerHTML = '<option value="">Select a port</option>'

          availablePorts.forEach(port => {
            const option = document.createElement('option')
            option.value = port
            option.textContent = port
            portSelect.appendChild(option)
          })
        } catch (error) {
          console.error('Error loading ports:', error)
          document.getElementById('app-port').innerHTML =
            '<option value="">Error loading ports</option>'
          showMessage('Failed to load available ports. Please try again.', true)
        }
      }

      function showCreateAppModal() {
        document.getElementById('create-app-modal').style.display = 'flex'
        // Hide any previous messages
        document.getElementById('success-message').style.display = 'none'
        document.getElementById('error-message').style.display = 'none'
        initializeCreateAppModal()
      }

      function closeCreateAppModal() {
        document.getElementById('create-app-modal').style.display = 'none'
        document.getElementById('create-app-form').reset()
        document.getElementById('app-type-options').innerHTML = ''
        document.getElementById('database-options').style.display = 'none'
        document.getElementById('success-message').style.display = 'none'
        document.getElementById('error-message').style.display = 'none'
      }

      function updateAppTypeOptions() {
        const appType = document.getElementById('app-type').value
        const optionsContainer = document.getElementById('app-type-options')

        if (!appType || !appTemplates[appType]) {
          optionsContainer.innerHTML = ''
          return
        }

        const template = appTemplates[appType]
        let optionsHTML = ''

        // Version selection
        if (template.versions) {
          optionsHTML += `
           <div class="app-type-option">
               <label>${
                 appType.charAt(0).toUpperCase() + appType.slice(1)
               } Version</label>
               <div class="version-grid" id="version-options">
                   ${template.versions
                     .map(
                       version =>
                         `<div class="version-option" onclick="selectVersion('${version}')" data-version="${version}">
                           ${version}
                       </div>`
                     )
                     .join('')}
               </div>
           </div>
       `
        }

        // Build tool selection (for Java)
        if (template.buildTools) {
          optionsHTML += `
           <div class="app-type-option">
               <label>Build Tool</label>
               <select id="build-tool">
                   ${template.buildTools
                     .map(
                       tool =>
                         `<option value="${tool}">${
                           tool.charAt(0).toUpperCase() + tool.slice(1)
                         }</option>`
                     )
                     .join('')}
               </select>
           </div>
       `
        }

        // Custom base image (for custom type)
        if (appType === 'custom') {
          optionsHTML += `
           <div class="app-type-option">
               <label>Base Docker Image*</label>
               <input type="text" id="base-image" placeholder="ubuntu:20.04" required>
           </div>
           <div class="app-type-option">
               <label>Custom Instructions (one per line)</label>
               <textarea id="custom-instructions" rows="4" placeholder="RUN apt-get update&#10;RUN apt-get install -y curl"></textarea>
           </div>
       `
        }

        optionsContainer.innerHTML = optionsHTML

        // Update example commands
        updateExampleCommands(appType)

        // Auto-select first version
        if (template.versions) {
          selectVersion(template.versions[0])
        }
      }

      function selectVersion(version) {
        document.querySelectorAll('.version-option').forEach(option => {
          option.classList.remove('selected')
        })
        const versionElement = document.querySelector(
          `[data-version="${version}"]`
        )
        if (versionElement) {
          versionElement.classList.add('selected')
        }
      }

      function updateExampleCommands(appType) {
        const template = appTemplates[appType]
        if (!template || !template.defaultStartCommands) return

        // Clear existing commands
        const container = document.getElementById('start-commands-container')
        container.innerHTML = ''

        // Add default command
        const defaultCmd = template.defaultStartCommands[0]
        addCommandFromArray(defaultCmd)

        // Update health check placeholder
        const healthCheckInput = document.getElementById('health-check')
        if (template.healthCheck) {
          healthCheckInput.placeholder = template.healthCheck.replace(
            '{{port}}',
            'PORT'
          )
        }
      }

      function addCommandFromArray(cmdArray) {
        const container = document.getElementById('start-commands-container')
        const commandDiv = document.createElement('div')
        commandDiv.className = 'command-input'

        const commandParts = cmdArray
          .map(
            (part, index) =>
              `<input type="text" value="${part}" class="cmd-part" ${
                index === 0 ? 'required' : ''
              }>`
          )
          .join('')

        commandDiv.innerHTML = `
       ${commandParts}
       <button type="button" onclick="addCommandPart(this)">+</button>
       <button type="button" onclick="removeCommandPart(this)">-</button>
   `

        container.appendChild(commandDiv)
      }

      function addCommandPart(button) {
        const commandDiv = button.parentElement
        const newInput = document.createElement('input')
        newInput.type = 'text'
        newInput.className = 'cmd-part'
        newInput.placeholder = 'arg'

        commandDiv.insertBefore(newInput, button)
      }

      function removeCommandPart(button) {
        const commandDiv = button.parentElement
        const inputs = commandDiv.querySelectorAll('.cmd-part')

        if (inputs.length > 1) {
          inputs[inputs.length - 1].remove()
        }
      }

      function addEnvVar() {
        const container = document.getElementById('env-vars-container')
        const envDiv = document.createElement('div')
        envDiv.className = 'env-var-input'
        envDiv.innerHTML = `
       <input type="text" placeholder="VARIABLE_NAME" class="env-key">
       <input type="text" placeholder="value" class="env-value">
       <button type="button" onclick="addEnvVar()">+</button>
       <button type="button" onclick="removeEnvVar(this)">-</button>
   `
        container.appendChild(envDiv)
      }

      function removeEnvVar(button) {
        const container = document.getElementById('env-vars-container')
        if (container.children.length > 1) {
          button.parentElement.remove()
        }
      }

      function updateDatabaseOptions() {
        const dbType = document.getElementById('db-type').value
        const dbOptions = document.getElementById('database-options')

        if (dbType === 'none') {
          dbOptions.style.display = 'none'
        } else {
          dbOptions.style.display = 'block'

          // Auto-fill database name based on app name
          const appName = document.getElementById('app-name').value
          if (appName) {
            document.getElementById('db-name').value = `${appName}_db`
            document.getElementById('db-username').value = `${appName}_user`
          }
        }
      }

      async function createNewApp(event) {
        event.preventDefault()

        const submitBtn = document.getElementById('create-app-btn')
        submitBtn.disabled = true
        submitBtn.textContent = 'Creating App...'

        // Hide any previous messages
        document.getElementById('success-message').style.display = 'none'
        document.getElementById('error-message').style.display = 'none'

        try {
          // Collect form data
          const formData = collectFormData()

          // Validate form data
          if (!validateFormData(formData)) {
            throw new Error('Please fill in all required fields')
          }

          console.log('Sending app creation request:', formData)

          // Submit to your server
          const response = await fetch(`${SERVER_URL}/api/apps/create`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })

          const result = await response.json()

          if (!response.ok) {
            throw new Error(result.error || 'Failed to create app')
          }

          // Store form data in localStorage
          localStorage.setItem(
            'lastCreatedApp',
            JSON.stringify(formData)
          )

          // Close the modal
          const modal = document.getElementById('create-app-modal')
          modal.style.display = 'none'

          // Connect to WebSocket for progress updates
          const wsUrl = `${SERVER_URL.replace('http://', 'ws://')}/ws?app=${
            formData.name
          }`
          console.log('Connecting to WebSocket:', wsUrl)
          const ws = new WebSocket(wsUrl)

          // Update UI with progress
          const progressDiv = document.createElement('div')
          progressDiv.className = 'progress-container'
          progressDiv.innerHTML = `
                <div class="progress-bar"></div>
                <div class="progress-text">Creating app...</div>
            `
          document.body.appendChild(progressDiv)

          ws.onmessage = event => {
            const update = JSON.parse(event.data)

            if (update.error) {
              progressDiv.style.display = 'none'
              throw new Error(update.error)
            }

            if (update.status === 'completed') {
              progressDiv.style.display = 'none'
              // Success!
              showMessage(
                `App "${formData.name}" created successfully! Access it at: ${
                  result.url || `http://localhost:8080/${formData.name}/`
                }`
              )

              // Close the form
              document.querySelector('.create-app-form').style.display = 'none'

              // Refresh the dashboard data
              loadDashboardData()
            } else if (update.status === 'failed') {
              progressDiv.style.display = 'none'
              throw new Error(update.error)
            } else {
              // Update progress text
              progressDiv.querySelector('.progress-text').textContent =
                update.message
            }
          }

          ws.onclose = () => {
            progressDiv.style.display = 'none'
          }

          ws.onerror = () => {
            progressDiv.style.display = 'none'
            throw new Error('WebSocket connection error')
          }
        } catch (error) {
          console.error('Error creating app:', error)
          showMessage('Error creating app: ' + error.message, true)
        } finally {
          submitBtn.disabled = false
          submitBtn.textContent = 'Create App'
        }
      }

      function collectFormData() {
        const appType = document.getElementById('app-type').value
        const selectedVersion = document.querySelector(
          '.version-option.selected'
        )?.dataset.version

        // Collect start commands
        const startCommands = []
        document.querySelectorAll('.command-input').forEach(cmdDiv => {
          const parts = []
          cmdDiv.querySelectorAll('.cmd-part').forEach(input => {
            if (input.value.trim()) {
              parts.push(input.value.trim())
            }
          })
          if (parts.length > 0) {
            startCommands.push(...parts)
          }
        })

        // Collect environment variables
        const environment = {}
        document.querySelectorAll('.env-var-input').forEach(envDiv => {
          const key = envDiv.querySelector('.env-key').value.trim()
          const value = envDiv.querySelector('.env-value').value.trim()
          if (key && value) {
            environment[key] = value
          }
        })

        // App configuration
        const appConfig = {}
        if (selectedVersion) {
          appConfig[`${appType}Version`] = selectedVersion
        }

        if (appType === 'java') {
          const buildTool = document.getElementById('build-tool')?.value
          if (buildTool) appConfig.buildTool = buildTool
        }

        if (appType === 'custom') {
          const baseImage = document.getElementById('base-image')?.value
          if (baseImage) appConfig.baseImage = baseImage

          const customInstructions = document.getElementById(
            'custom-instructions'
          )?.value
          if (customInstructions) {
            appConfig.customInstructions = customInstructions
              .split('\n')
              .filter(line => line.trim())
          }
        }

        // Database configuration
        const dbType = document.getElementById('db-type').value
        const database = { type: dbType }

        if (dbType !== 'none') {
          database.name =
            document.getElementById('db-name').value ||
            `${document.getElementById('app-name').value}_db`
          database.credentials = {
            username:
              document.getElementById('db-username').value ||
              `${document.getElementById('app-name').value}_user`,
            password:
              document.getElementById('db-password').value || 'password123'
          }
        }

        return {
          name: document.getElementById('app-name').value.trim(),
          githubRepo: document.getElementById('github-repo').value.trim(),
          credentials: {
            githubPAT: document.getElementById('github-pat').value.trim()
          },
          environment,
          port: parseInt(document.getElementById('app-port').value),
          appType,
          appConfig,
          database,
          startCommands,
          buildCommand:
            document.getElementById('build-command').value.trim() || undefined,
          healthCheck:
            document.getElementById('health-check').value.trim() || undefined
        }
      }

      function validateFormData(data) {
        const required = ['name', 'githubRepo', 'port', 'appType']

        for (const field of required) {
          if (!data[field]) {
            showMessage(
              `Please fill in the ${field
                .replace(/([A-Z])/g, ' $1')
                .toLowerCase()} field`,
              true
            )
            return false
          }
        }

        if (!data.startCommands || data.startCommands.length === 0) {
          showMessage('Please provide start commands', true)
          return false
        }

        if (!data.credentials.githubPAT) {
          showMessage('Please provide a GitHub Personal Access Token', true)
          return false
        }

        // Validate app name format
        if (!/^[a-z0-9-]+$/.test(data.name)) {
          showMessage(
            'App name must be lowercase with only letters, numbers, and hyphens',
            true
          )
          return false
        }

        return true
      }

      function updateNewButtonHandler() {
        const newBtn = document.getElementById('new-btn')
        if (newBtn) {
          newBtn.addEventListener('click', function () {
            if (document.getElementById('overview').style.display !== 'none') {
              // In overview, show create app modal
              showCreateAppModal()
            } else {
              // In project view, show add environment modal (placeholder for future feature)
              showMessage('Add Environment functionality coming soon!')
            }
          })
        }
      }

      // Main data loading function
      async function loadDashboardData() {
        try {
          console.log('ðŸ“Š Loading dashboard data...')

          // Try to fetch docker-compose data first
          const composeData = await fetchDockerCompose()

          if (composeData) {
            console.log('âœ… Successfully fetched docker-compose data')

            // Parse services from docker-compose
            const { services, projects } = parseServices(composeData)
            allServices = services
            allProjects = projects

            console.log(
              `Found ${projects.length} projects and ${services.length} services`
            )

            // Initial render
            renderServices()
            renderProjects()
            updateCounts()

            // Then update health status
            await updateServicesHealth()
          } else {
            console.warn(
              'âš ï¸ Could not fetch docker-compose data, falling back to detection mode'
            )
            // Fallback to the old detection method
            await detectServices()
          }
        } catch (error) {
          console.error('âŒ Error loading dashboard data:', error)
          showMessage(
            'Failed to load dashboard data. Please check if the app manager is running.',
            true
          )

          // Show empty state
          renderEmptyState()
        }
      }

      async function detectServices() {
        // Common app names that might exist
        const commonApps = ['projectx']
        const detectedServices = []
        const detectedProjects = new Set()

        for (const appName of commonApps) {
          try {
            const healthData = await checkHealth(appName)

            if (healthData.status === 'UP') {
              // Main application service
              detectedServices.push({
                name: appName,
                projectName: appName,
                type: 'application',
                runtime: 'Java Spring Boot', // Could be inferred from health endpoint
                port: null,
                status: 'UP',
                healthDetails: healthData
              })

              detectedProjects.add(appName)

              // Check if it has a database component
              if (healthData.components && healthData.components.db) {
                detectedServices.push({
                  name: `${appName}-db`,
                  projectName: appName,
                  type: 'database',
                  runtime:
                    healthData.components.db.details?.database || 'PostgreSQL',
                  port: null,
                  status: healthData.components.db.status,
                  healthDetails: healthData.components.db
                })
              }
            }
          } catch (error) {
            // Service doesn't exist or is not accessible
            continue
          }
        }

        allServices = detectedServices
        allProjects = Array.from(detectedProjects)

        renderServices()
        renderProjects()
        updateCounts()
      }

      function renderEmptyState() {
        const projectsGrid = document.getElementById('projects-grid')
        const servicesTableBody = document.getElementById('services-table-body')

        projectsGrid.innerHTML =
          '<div class="no-projects">No projects found. Create your first app using the "New" button above.</div>'
        servicesTableBody.innerHTML =
          '<div class="no-services">No services found.</div>'

        // Update counts
        document.getElementById('active-count').textContent = '0'
        document.getElementById('suspended-count').textContent = '0'
        document.getElementById('total-count').textContent = '0'
      }

      function addRefreshButton() {
        const headerActions = document.querySelector('.header-actions')
        const refreshBtn = document.createElement('button')
        refreshBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
        </svg>
        Refresh
    `
        refreshBtn.className = 'new-btn'
        refreshBtn.style.background = '#059669'
        refreshBtn.style.marginRight = '12px'
        refreshBtn.onclick = async () => {
          refreshBtn.disabled = true
          refreshBtn.textContent = 'Refreshing...'
          try {
            await loadDashboardData()
            showMessage('Dashboard data refreshed successfully!')
          } catch (error) {
            showMessage('Failed to refresh dashboard data', true)
          } finally {
            refreshBtn.disabled = false
            refreshBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                Refresh
            `
          }
        }

        headerActions.insertBefore(refreshBtn, headerActions.firstChild)
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', async function () {
        console.log('ðŸš€ Initializing dashboard...')

        // Add refresh button
        addRefreshButton()

        // Load initial dashboard data
        await loadDashboardData()

        // Set up periodic health checks (every 30 seconds)
        setInterval(async () => {
          if (allServices.length > 0) {
            await updateServicesHealth()
          }
        }, 30000)

        // Add tab functionality
        setupTabs()
        // Add search functionality
        setupSearch()
        // Setup new button functionality
        updateNewButtonHandler()

        // Auto-update database name when app name changes
        const appNameInput = document.getElementById('app-name')
        if (appNameInput) {
          appNameInput.addEventListener('input', function () {
            const appName = this.value
            const dbType = document.getElementById('db-type').value

            if (dbType !== 'none' && appName) {
              document.getElementById('db-name').value = `${appName}_db`
              document.getElementById('db-username').value = `${appName}_user`
            }
          })
        }

        // Test server connection on page load
        fetch(`${SERVER_URL}/api/apps/templates`)
          .then(response => {
            if (!response.ok) {
              console.warn(
                'âš ï¸ App manager API not available. Using detection mode.'
              )
            } else {
              console.log('âœ… App manager API is available')
            }
          })
          .catch(error => {
            console.warn('âš ï¸ Server connection failed:', error)
          })

        console.log('âœ… Dashboard initialization complete')
      })
    </script>
  </body>
</html>
